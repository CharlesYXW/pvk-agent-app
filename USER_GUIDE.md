# 钙钛矿研发智能助手 - 完整使用指南

> **版本**: v0.3.1  
> **更新日期**: 2025-10-22  
> **适用场景**: 钙钛矿材料研发的完整 AI Agent 系统

---

## 📑 目录

1. [快速开始](#-快速开始)
2. [系统状态监控](#-系统状态监控)
3. [功能模块详解](#-功能模块详解)
4. [UI 设计说明](#-ui-设计说明)
5. [故障排查](#-故障排查)
6. [更新日志](#-更新日志)
7. [常见问题](#-常见问题)

---

## 🚀 快速开始

### 环境要求

- **Python 环境**: Conda 环境 `mylangchain`
- **依赖包**: 见 `requirements.txt`
- **API 密钥**: DashScope API Key（用于 AI 功能）

### 一键启动（推荐）

```bash
# 双击项目根目录下的启动脚本
./start_app.command
```

脚本会自动：
- ✅ 激活 `mylangchain` 环境
- ✅ 检查并关闭占用端口的进程
- ✅ 启动 Streamlit 应用
- ✅ 在浏览器中打开应用

### 手动启动

```bash
# 1. 激活 Conda 环境
conda activate mylangchain

# 2. 安装依赖（首次运行）
pip install -r requirements.txt

# 3. 启动应用
streamlit run app.py
```

### 首次配置

#### 1. 设置 API 密钥

**方式一：环境变量**（推荐）
```bash
export DASHSCOPE_API_KEY='your_api_key_here'
```

**方式二：.env 文件**
```bash
# 在项目根目录创建 .env 文件
echo "DASHSCOPE_API_KEY=your_api_key_here" > .env
```

#### 2. 构建知识库索引

```bash
python build_knowledge_base.py
```

构建完成后，会在项目根目录生成 `faiss_index/` 文件夹。

#### 3. 准备数据（可选）

- **知识库文档**: 将 `.txt` 文件放入 `knowledge_base_docs/` 目录
- **XRD 数据**: 将实验数据放入 `experimental_data/xrd/` 目录
- **训练数据**: 替换 `simulated_experimental_data.csv`

---

## 🔍 系统状态监控

### 功能概述

应用顶部的**系统状态面板**会实时检测所有依赖是否就绪，帮助您快速定位问题。

### 检测项目

| 检查项 | 说明 | 重要性 |
|--------|------|--------|
| **🔑 API 密钥** | DashScope API Key 配置状态 | ⭐⭐⭐ 核心 |
| **📚 知识库索引** | FAISS 向量索引是否构建 | ⭐⭐⭐ 核心 |
| **📄 知识文档** | 文档目录中的文件数量 | ⭐⭐ 重要 |
| **📊 XRD 数据** | 示例分析数据是否存在 | ⭐ 可选 |
| **🧪 训练数据** | 性能预测模型训练数据 | ⭐⭐ 重要 |
| **🐍 运行环境** | 是否在 mylangchain 环境 | ⭐⭐⭐ 核心 |

### 健康状态说明

```
✅ 系统运行正常 - 所有依赖就绪，功能完整
⚠️ 部分功能受限 - 核心功能正常，可选功能不可用
❌ 核心依赖缺失 - 需要立即处理（面板会自动展开）
```

### 快速修复

状态面板会为每个未就绪的项目提供**一键复制的修复命令**：

```bash
# API 密钥
export DASHSCOPE_API_KEY='your_key'

# 知识库索引
python build_knowledge_base.py

# 运行环境
conda activate mylangchain
```

---

## 💡 功能模块详解

### 1. 💬 知识库问答

**功能**: 基于内部文档的 RAG 智能问答系统

**适用场景**:
- 查询历史实验记录
- 检索内部技术文档
- 获取工艺参数建议

**使用方法**:
1. 在输入框中输入问题
2. AI 会先检索知识库
3. 如果找到相关信息，基于文档回答
4. 如果没有相关信息，使用通用知识回答（会明确标注）

**技术特点**:
- ✅ 基于 FAISS 向量检索
- ✅ 使用 LangChain RAG 架构
- ✅ 防止 AI "杜撰"信息

---

### 2. 📰 文献检索

**功能**: 自动检索 arXiv 最新科研论文

**适用场景**:
- 追踪钙钛矿领域最新进展
- 获取特定主题的文献
- 生成科研动态简报

**使用方法**:
1. 输入关键词（多个用逗号分隔）
2. 选择时间范围（最近一个月/三个月/一年/所有）
3. 选择排序方式（相关度/最新发表）
4. 点击"开始检索"

**功能按钮**:
- **阅读原文**: 跳转到 PDF 下载页面
- **AI 总结**: 使用 AI 提炼论文核心观点
- **深入研究**: 计划中的全文分析功能

**性能优化**:
- ✅ 自动去重（基于 DOI 和 entry_id）
- ✅ 支持缓存（减少重复请求）
- ✅ 尊重 arXiv API 速率限制

---

### 3. 📈 XRD 分析

**功能**: 自动分析 X 射线衍射数据

**适用场景**:
- 快速识别衍射峰
- 绘制标准图谱
- 批量处理实验数据

**使用方法**:
1. 准备数据文件（`.txt` 或 `.csv`）
2. 文件格式：两列（角度, 强度）
3. 上传文件
4. 自动生成图谱和峰位标注

**输出内容**:
- 完整的 XRD 图谱
- 自动标注的主要衍射峰
- 峰位角度数值

---

### 4. 💡 性能预测

**功能**: AI 预测材料光电转换效率

**适用场景**:
- 实验前参数评估
- 优化实验设计
- 减少试错成本

**使用方法**:
1. 调整三个参数滑块：
   - 旋涂速度 (2000-6000 rpm)
   - 退火温度 (80-140°C)
   - 添加剂浓度 (0.1-2.0%)
2. 点击"执行预测"
3. 查看预测效率

**模型说明**:
- 算法：随机森林回归
- 训练数据：`simulated_experimental_data.csv`
- 可扩展：支持更换为真实数据

**未来升级**:
- 🔄 贝叶斯优化
- 🔄 不确定性量化
- 🔄 多目标优化（效率 + 稳定性）

---

### 5. 🚀 实验优化

**功能**: 智能推荐最佳实验参数

**适用场景**:
- 寻找全局最优参数
- 替代传统试错法
- 加速配方开发

**使用方法**:
1. 点击"开始优化"
2. AI 在参数空间中搜索
3. 返回预测效率最高的参数组合

**搜索范围**（可配置）:
- 旋涂速度: 2500-5500 rpm（步长 500）
- 退火温度: 80-120°C（步长 10）
- 添加剂浓度: 0.5-1.5%（步长 0.2）

**输出内容**:
- 最高预测效率
- 推荐的参数组合表格

---

## 🎨 UI 设计说明

### 配色方案（v0.3.1）

我们采用**专业、沉稳**的配色系统：

#### 导航按钮
- **选中状态**: 深蓝色 `#1e3a8a`
- **悬停效果**: 中蓝色 `#1e40af`
- **设计理念**: 商务化、专业感

#### 页面头部卡片

| 页面 | 配色 | 设计意图 |
|------|------|----------|
| 💬 知识库问答 | 深蓝灰 `#2c3e50→#34495e` | 专业、稳重 |
| 📰 文献检索 | 深绿 `#16a085→#1abc9c` | 清新、学术 |
| 📈 XRD分析 | 深蓝 `#2980b9→#3498db` | 科技、可靠 |
| 💡 性能预测 | 深绿灰 `#27ae60→#2ecc71` | 成熟、理性 |
| 🚀 实验优化 | 深橙灰 `#d35400→#e67e22` | 温暖、专业 |

**设计原则**:
- ✅ 低饱和度，减少视觉疲劳
- ✅ 深色调，提升专业感
- ✅ 足够对比度，确保可读性
- ✅ 统一风格，增强一致性

### 快捷操作（侧边栏）

**位置**: 侧边栏底部  
**功能**: 快速访问常用命令

**交互方式**:
1. 点击按钮 → 显示命令
2. 再次点击 → 隐藏命令
3. 点击另一个按钮 → 自动切换

**优化亮点**:
- ✅ 命令显示在侧边栏内，不溢出
- ✅ 使用 `session_state` 管理状态
- ✅ 互斥显示，避免混乱

---

## 🔧 故障排查

### 问题 1: 模块导入错误

**错误信息**: `ModuleNotFoundError: No module named 'xxx'`

**原因**: 未在正确的 Conda 环境中运行

**解决方案**:
```bash
# 1. 激活环境
conda activate mylangchain

# 2. 安装依赖
pip install -r requirements.txt

# 3. 验证环境
conda env list  # 确认有 * 标记在 mylangchain
```

---

### 问题 2: 知识库问答不可用

**错误信息**: "知识库索引未找到"

**原因**: 未构建 FAISS 索引

**解决方案**:
```bash
# 1. 检查文档目录
ls knowledge_base_docs/  # 应该有 .txt 文件

# 2. 构建索引
python build_knowledge_base.py

# 3. 验证
ls faiss_index/  # 应该有 index.faiss 和 index.pkl
```

---

### 问题 3: AI 功能无响应

**可能原因**: API 密钥未配置或无效

**解决方案**:
```bash
# 1. 检查环境变量
echo $DASHSCOPE_API_KEY

# 2. 设置 API 密钥
export DASHSCOPE_API_KEY='sk-xxxxxxxxxx'

# 3. 重启应用
streamlit run app.py
```

---

### 问题 4: 端口被占用

**错误信息**: `Port 8501 is already in use`

**解决方案**:

**方式一：使用启动脚本**（自动处理）
```bash
./start_app.command
```

**方式二：手动处理**
```bash
# 查找占用进程
lsof -ti:8501

# 杀死进程
kill -9 $(lsof -ti:8501)

# 启动应用
streamlit run app.py
```

---

### 问题 5: 快捷操作显示不全

**表现**: 点击快捷操作按钮后，内容被遮挡

**状态**: ✅ 已在 v0.3.1 修复

**解决方案**: 更新到最新版本即可

---

## 📝 更新日志

### [v0.3.1] - 2025-10-22

**UI 配色优化**
- ✅ 导航按钮从红色改为深蓝色
- ✅ 所有页面头部采用沉稳配色
- ✅ 修复快捷操作显示问题

### [v0.3.0] - 2025-10-22

**新增功能**
- ✅ 系统状态监控面板
- ✅ 卡片式导航设计
- ✅ 页面头部渐变色优化
- ✅ 快捷操作区

**技术改进**
- ✅ 独立的系统状态检测模块
- ✅ 完善的文档体系

### [v0.2.0] - 2025-10-17

**启动流程优化**
- ✅ 一键启动脚本
- ✅ 端口检测和进程管理
- ✅ 自动打开浏览器

**UI 优化**
- ✅ 文献检索排序选项
- ✅ AI 身份设定

### [v0.1.0] - 2025-10-16

**初始版本**
- ✅ 知识库问答（RAG）
- ✅ 文献检索（arXiv）
- ✅ XRD 自动分析
- ✅ 性能预测模型
- ✅ 实验参数优化

---

## ❓ 常见问题

### Q1: 为什么需要 API 密钥？

**A**: API 密钥用于调用阿里云通义千问大模型，实现：
- 知识库智能问答
- 文献 AI 总结
- 其他 AI 辅助功能

没有 API 密钥，仍可使用：
- XRD 数据分析
- 性能预测
- 实验优化

---

### Q2: 可以使用自己的数据吗？

**A**: 完全可以！按以下步骤替换：

**知识库**:
1. 将 `.txt` 文档放入 `knowledge_base_docs/`
2. 运行 `python build_knowledge_base.py`

**实验数据**:
1. 准备 CSV 文件，包含以下列：
   - `spin_coating_rpm`
   - `annealing_temperature_C`
   - `additive_concentration_percent`
   - `efficiency_percent`
2. 替换 `simulated_experimental_data.csv`
3. 重启应用即可

---

### Q3: 如何获取 API 密钥？

**A**: 
1. 访问阿里云 DashScope 平台
2. 注册/登录账号
3. 创建 API Key
4. 按照[快速开始](#-快速开始)中的方法配置

---

### Q4: 支持哪些文献检索来源？

**A**: 当前版本支持：
- ✅ arXiv（物理、化学、材料学等）

**计划支持**:
- 🔄 ACS Publications
- 🔄 Nature/Science 系列
- 🔄 中国知网（CNKI）

---

### Q5: 性能预测准确吗？

**A**: 
- **演示版**：基于模拟数据，仅供功能展示
- **生产版**：准确度取决于训练数据的质量和数量

**建议**:
1. 收集至少 100 组真实实验数据
2. 包含失败案例（提高模型鲁棒性）
3. 定期更新训练数据
4. 进行模型验证和调优

---

### Q6: 可以部署到服务器吗？

**A**: 可以！支持多种部署方式：

**本地服务器**:
```bash
streamlit run app.py --server.port 8501 --server.address 0.0.0.0
```

**Docker 部署**（推荐）:
```dockerfile
FROM python:3.12
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["streamlit", "run", "app.py"]
```

**云端部署**:
- Streamlit Cloud
- 阿里云 ECS
- 腾讯云轻量应用服务器

---

### Q7: 如何更新到最新版本？

**A**:
```bash
# 1. 拉取最新代码（如果使用 Git）
git pull origin main

# 2. 更新依赖
pip install -r requirements.txt --upgrade

# 3. 重新构建知识库（如果有更新）
python build_knowledge_base.py

# 4. 重启应用
streamlit run app.py
```

---

### Q8: 支持多用户同时使用吗？

**A**: 
- **当前版本**: 单用户使用，无权限管理
- **计划功能**: 多用户支持（长期规划）

如需多用户功能，建议：
1. 为每个用户部署独立实例
2. 或等待多用户功能上线

---

## 📚 相关资源

### 文档
- `README.md` - 项目总览和阶段规划
- `DEPLOYMENT_GUIDE.md` - 详细部署指南
- `TODO.md` - 功能开发计划

### 数据目录
- `knowledge_base_docs/` - 知识库文档
- `experimental_data/xrd/` - XRD 实验数据
- `research_briefings/` - 科研简报输出

### 核心模块
- `app.py` - 主应用
- `system_status.py` - 系统状态检测
- `build_knowledge_base.py` - 知识库构建
- `xrd_analyzer.py` - XRD 分析
- `performance_predictor.py` - 性能预测
- `optimizer.py` - 参数优化

---

## 🎯 下一步计划

### Quick Wins (1-2 周)
- [ ] 文献检索结果缓存
- [ ] 模型输入校验
- [ ] 搜索空间配置抽象

### 中期建设 (1-2 月)
- [ ] 知识库多格式支持（PDF/DOCX）
- [ ] 知识库管理面板
- [ ] 贝叶斯优化升级
- [ ] 实验日志系统

### 长期规划
- [ ] 多实验类型支持（PL/SEM/IV）
- [ ] 工作流自动化
- [ ] 多用户权限管理
- [ ] LIMS/ELN 系统对接

---

## 💬 反馈与支持

如有任何问题、建议或需求，欢迎随时反馈！

**联系方式**: [待补充]

---

**感谢使用晶澳钙钛矿研发智能助手！** 🚀

*本文档持续更新中，最后更新时间: 2025-10-22*
